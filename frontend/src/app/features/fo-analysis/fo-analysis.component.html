<div class="fo-analysis fade-in">
  <header class="page-header">
    <div class="header-content">
      <h1>F&O Analysis</h1>
      <p>Analyze Futures and Options data from NSE</p>
    </div>
  </header>

  <!-- Tabs -->
  <div class="main-tabs">
    <button class="main-tab" [class.active]="activeTab === 'nifty'" (click)="onTabChange('nifty')">
      <span class="tab-icon">üìä</span>
      NIFTY Index
    </button>
    <button class="main-tab" [class.active]="activeTab === 'futures'" (click)="onTabChange('futures')">
      <span class="tab-icon">üìà</span>
      Futures
    </button>
    <button class="main-tab" [class.active]="activeTab === 'options'" (click)="onTabChange('options')">
      <span class="tab-icon">‚ö°</span>
      Options
    </button>
  </div>

  <!-- Filters -->
  <section class="filters-section">
    <div class="filters-card">
      <div class="filter-group">
        <label>Date</label>
        <input type="date" [(ngModel)]="selectedDate" class="date-input" />
      </div>

      @if (activeTab !== 'nifty') {
      <div class="filter-group">
        <label>Symbol</label>
        <input type="text" [(ngModel)]="symbol" placeholder="e.g., NIFTY, BANKNIFTY" class="text-input" />
      </div>
      } @else {
      <!-- NIFTY Tab Specific Filters -->
      <div class="filter-group">
        <label>Ticker Symbol</label>
        <select [(ngModel)]="selectedSymbol" (change)="onSymbolChange()" class="select-input">
          @for (sym of uniqueSymbols; track sym) {
          <option [value]="sym">{{ sym }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <label>Expiry Date</label>
        <select [(ngModel)]="selectedExpiry" (change)="onExpiryChange()" class="select-input">
          @for (exp of uniqueExpiries; track exp) {
          <option [value]="exp">{{ exp }}</option>
          }
        </select>
      </div>
      }

      @if (activeTab === 'options') {
      <div class="filter-group">
        <label>Option Type</label>
        <select [(ngModel)]="optionType" class="select-input">
          <option value="">All</option>
          <option value="CE">Call (CE)</option>
          <option value="PE">Put (PE)</option>
        </select>
      </div>
      }

      <button class="btn" (click)="refresh()" [disabled]="loading">
        @if (loading) {
        <span class="btn-spinner"></span>
        }
        Refresh Data
      </button>
    </div>
  </section>

  <!-- Error -->
  @if (error) {
  <div class="error-alert">
    <span>‚ö†Ô∏è</span> {{ error }}
  </div>
  }

  <!-- Loading -->
  @if (loading) {
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Loading data...</p>
  </div>
  }

  <!-- NIFTY Tab Content -->
  @if (activeTab === 'nifty' && niftyData && !loading) {
  <section class="results-section">
    <div class="summary-grid">
      <div class="summary-card">
        <span class="summary-icon">üìà</span>
        <div class="summary-content">
          <span class="summary-value">{{ filteredFutures.length }}</span>
          <span class="summary-label">Futures Contracts</span>
        </div>
      </div>
      <div class="summary-card">
        <span class="summary-icon">‚ö°</span>
        <div class="summary-content">
          <span class="summary-value">{{ filteredOptions.length }}</span>
          <span class="summary-label">Options Contracts</span>
        </div>
      </div>
    </div>

    <h3 class="section-title">NIFTY Futures</h3>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Expiry</th>
            <th class="text-right">Open</th>
            <th class="text-right">High</th>
            <th class="text-right">Low</th>
            <th class="text-right">Close</th>
            <th class="text-right">Volume</th>
          </tr>
        </thead>
        <tbody>
          @for (item of filteredFutures; track $index) {
          <tr>
            <td><span class="symbol-badge">{{ item.TckrSymb }}</span></td>
            <td>{{ item.XpryDt }}</td>
            <td class="text-right">{{ item.OpnPric | number:'1.2-2' }}</td>
            <td class="text-right">{{ item.HghPric | number:'1.2-2' }}</td>
            <td class="text-right">{{ item.LwPric | number:'1.2-2' }}</td>
            <td class="text-right">{{ item.ClsPric | number:'1.2-2' }}</td>
            <td class="text-right">{{ item.TtlTrdVol | number }}</td>
          </tr>
          }
          @empty {
          <tr>
            <td colspan="7" class="text-center">No futures found for this selection.</td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <h3 class="section-title" style="margin-top: 2rem;">NIFTY Options</h3>
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Type</th>
            <th class="text-right">Strike</th>
            <th>Expiry</th>
            <th class="text-right">Close</th>
            <th class="text-right">OI</th>
            <th class="text-right">Volume</th>
          </tr>
        </thead>
        <tbody>
          @for (item of filteredOptions; track $index) {
          <tr>
            <td><span class="symbol-badge">{{ item.TckrSymb }}</span></td>
            <td>
              <span class="option-type"
                [class.call]="item.OptnTp === 'CE' || (item.FinInstrmNm && item.FinInstrmNm.includes('CE'))"
                [class.put]="item.OptnTp === 'PE' || (item.FinInstrmNm && item.FinInstrmNm.includes('PE'))">
                {{ item.OptnTp || (item.FinInstrmNm.includes('CE') ? 'CE' : 'PE') }}
              </span>
            </td>
            <td class="text-right">{{ item.StrkPric | number:'1.2-2' }}</td>
            <td>{{ item.XpryDt }}</td>
            <td class="text-right">{{ item.ClsPric | number:'1.2-2' }}</td>
            <td class="text-right">{{ item.OpnIntrst | number }}</td>
            <td class="text-right">{{ item.TtlTrdVol | number }}</td>
          </tr>
          }
          @empty {
          <tr>
            <td colspan="7" class="text-center">No options found for this selection.</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }

  <!-- Futures Tab Content -->
  @if (activeTab === 'futures' && futuresData.length > 0 && !loading) {
  <section class="results-section">
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Expiry</th>
            <th class="text-right">Open</th>
            <th class="text-right">High</th>
            <th class="text-right">Low</th>
            <th class="text-right">Close</th>
            <th class="text-right">OI</th>
          </tr>
        </thead>
        <tbody>
          @for (item of futuresData; track $index) {
          <tr>
            <td><span class="symbol-badge">{{ item.TckrSymb }}</span></td>
            <td>{{ item.XpryDt }}</td>
            <td class="text-right">{{ item.OpnPric | number:'1.2-2' }}</td>
            <td class="text-right">{{ item.HghPric | number:'1.2-2' }}</td>
            <td class="text-right">{{ item.LwPric | number:'1.2-2' }}</td>
            <td class="text-right">{{ item.ClsPric | number:'1.2-2' }}</td>
            <td class="text-right">{{ item.OpnIntrst | number }}</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }

  <!-- Options Tab Content -->
  @if (activeTab === 'options' && optionsData.length > 0 && !loading) {
  <section class="results-section">
    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Type</th>
            <th class="text-right">Strike</th>
            <th>Expiry</th>
            <th class="text-right">Close</th>
            <th class="text-right">OI</th>
            <th class="text-right">Volume</th>
          </tr>
        </thead>
        <tbody>
          @for (item of optionsData; track $index) {
          <tr>
            <td><span class="symbol-badge">{{ item.TckrSymb }}</span></td>
            <td>
              <span class="option-type" [class.call]="item.OptnTp === 'CE'" [class.put]="item.OptnTp === 'PE'">
                {{ item.OptnTp }}
              </span>
            </td>
            <td class="text-right">{{ item.StrkPric | number:'1.2-2' }}</td>
            <td>{{ item.XpryDt }}</td>
            <td class="text-right">{{ item.ClsPric | number:'1.2-2' }}</td>
            <td class="text-right">{{ item.OpnIntrst | number }}</td>
            <td class="text-right">{{ item.TtlTrdVol | number }}</td>
          </tr>
          }
        </tbody>
      </table>
    </div>
  </section>
  }
</div>